<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamSheet Demo Dashboard</title>
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border-color: #e2e8f0;
            --success-color: #10b981;
            --error-color: #ef4444;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            margin-bottom: 3rem;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary-color), #818cf8);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p.subtitle {
            font-size: 1.125rem;
            color: var(--text-sub);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid var(--border-color);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        .card h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-icon {
            font-size: 1.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            border: none;
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.2s;
            margin-bottom: 0.5rem;
        }

        .btn:hover {
            background-color: var(--primary-hover);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-main);
        }

        .btn-outline:hover {
            background-color: #f1f5f9;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-main);
            border-left: 4px solid var(--primary-color);
            padding-left: 1rem;
        }

        /* Monitor Section */
        #monitor {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-weight: 600;
            color: var(--text-sub);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-badge {
            display: inline-flex;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-done {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-running {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-failed {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #1e293b;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 50;
        }

        .toast.show {
            transform: translateY(0);
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>StreamSheet Demo</h1>
            <p class="subtitle">High-Performance Asynchronous Excel Exporting with Minimal Memory Footprint</p>
        </header>

        <div class="section-title">Data Management</div>
        <div class="grid">
            <div class="card">
                <h2><span class="card-icon">üóÑÔ∏è</span> MongoDB Seeding</h2>
                <p style="margin-bottom: 1rem; color: var(--text-sub); font-size: 0.875rem;">
                    Insert dummy data into MongoDB to test streaming exports.
                </p>
                <input type="number" id="mongoSeedCount" value="10000"
                    style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem;"
                    placeholder="Count (e.g. 10000)">
                <button class="btn btn-outline" onclick="seedMongo()">Seed Data</button>
            </div>

            <!-- PostgreSQL Seeding -->
            <div class="card">
                <h2><span class="card-icon">üêò</span> PostgreSQL Seeding</h2>
                <p style="margin-bottom: 1rem; color: var(--text-sub); font-size: 0.875rem;">
                    Insert dummy data into PostgreSQL to test JDBC/JPA exports.
                </p>
                <input type="number" id="postgresSeedCount" value="10000"
                    style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem;"
                    placeholder="Count (e.g. 10000)">
                <button class="btn btn-outline" onclick="seedPostgres()">Seed Data</button>
            </div>
        </div>

        <div class="section-title">Export Scenarios</div>
        <div class="grid">
            <div class="card">
                <h2><span class="card-icon">üöÄ</span> Basic Mock Export</h2>
                <p style="margin-bottom: 1rem; color: var(--text-sub); font-size: 0.875rem;">
                    Pure memory generation. No DB latency. Tests library throughput.
                </p>
                <button class="btn" onclick="startExport('basic')">Start Export (10k rows)</button>
            </div>

            <div class="card">
                <h2><span class="card-icon">üçÉ</span> MongoDB Streaming</h2>
                <p style="margin-bottom: 1rem; color: var(--text-sub); font-size: 0.875rem;">
                    Stream directly from MongoDB Cursor to Excel. Constant Memory.
                </p>
                <button class="btn" onclick="startExport('mongo')">Standard Export</button>
                <button class="btn btn-outline" onclick="startExport('mongo-optimized')">Optimized (Projection)
                    Export</button>
            </div>

            <div class="card">
                <h2><span class="card-icon">üíæ</span> JDBC/JPA Export</h2>
                <p style="margin-bottom: 1rem; color: var(--text-sub); font-size: 0.875rem;">
                    JDBC: Async ResultSet Streaming | JPA: Sync Direct Download (requires transaction)
                </p>
                <button class="btn" onclick="startExport('jdbc')">JDBC Export (Async)</button>
                <a href="/api/demo/jpa/export/download" class="btn btn-outline"
                    style="text-decoration: none; text-align: center;">JPA Export (Sync Download)</a>
            </div>
        </div>

        <div class="section-title">Job Monitor</div>
        <div id="monitor">
            <table>
                <thead>
                    <tr>
                        <th>Job ID</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Progress</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="jobTableBody">
                    <!-- Rows will be added here -->
                </tbody>
            </table>
            <div id="emptyState" style="text-align: center; padding: 2rem; color: var(--text-sub);">
                No active jobs recently. Start an export above.
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Job Started!</div>

    <script>
        const jobs = new Map(); // Store job details

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        async function seedMongo() {
            const count = document.getElementById('mongoSeedCount').value;
            try {
                const res = await fetch(`/api/demo/mongodb/seed?count=${count}`, { method: 'POST' });
                const data = await res.json();
                showToast(data.message);
            } catch (e) {
                console.error(e);
                showToast('Seeding failed');
            }
        }

        async function seedPostgres() {
            const count = document.getElementById('postgresSeedCount').value;
            try {
                const res = await fetch(`/api/demo/postgres/seed?count=${count}`, { method: 'POST' });
                const data = await res.json();
                showToast(data.message);
            } catch (e) {
                console.error(e);
                showToast('PostgreSQL Seeding failed');
            }
        }

        async function startExport(type) {
            let url = '';
            if (type === 'basic') url = '/api/demo/export?count=10000';
            else if (type === 'mongo') url = '/api/demo/mongodb/export';
            else if (type === 'mongo-optimized') url = '/api/demo/mongodb/export/optimized';
            else if (type === 'jdbc') url = '/api/demo/jdbc/export';
            else if (type === 'jpa') url = '/api/demo/jpa/export';

            try {
                const res = await fetch(url, { method: 'POST' });
                const data = await res.json();

                if (data.jobId) {
                    addJobToTable(data.jobId, type);
                    showToast(`Export Started: ${type}`);
                }
            } catch (e) {
                console.error(e);
                showToast('Export failed to start');
            }
        }

        function addJobToTable(jobId, type) {
            document.getElementById('emptyState').style.display = 'none';
            const tbody = document.getElementById('jobTableBody');

            const row = document.createElement('tr');
            row.id = `row-${jobId}`;
            row.innerHTML = `
            <td style="font-family: monospace;">${jobId.substring(0, 8)}...</td>
            <td>${type}</td>
            <td><span class="status-badge status-running" id="status-${jobId}">RUNNING</span></td>
            <td style="width: 200px;">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progress-${jobId}" style="width: 0%"></div>
                </div>
            </td>
            <td><span id="action-${jobId}" style="color: var(--text-sub); font-size: 0.875rem;">Waiting...</span></td>
        `;
            tbody.prepend(row);

            jobs.set(jobId, { type, active: true });
            pollJob(jobId);
        }

        async function pollJob(jobId) {
            const interval = setInterval(async () => {
                try {
                    const res = await fetch(`/api/demo/status/${jobId}`);
                    const data = await res.json(); // ExportJob

                    updateJobRow(jobId, data);

                    // Stop polling when job is finished
                    // ÏûëÏóÖÏù¥ ÏôÑÎ£åÎêòÎ©¥ Ìè¥ÎßÅ Ï§ëÏßÄ
                    if (data.status === 'COMPLETED' || data.status === 'FAILED' || data.status === 'CANCELLED') {
                        clearInterval(interval);
                        jobs.get(jobId).active = false;
                    }
                } catch (e) {
                    console.error("Polling error", e);
                }
            }, 1000);
        }

        function updateJobRow(jobId, status) {
            const badge = document.getElementById(`status-${jobId}`);
            const progress = document.getElementById(`progress-${jobId}`);
            const action = document.getElementById(`action-${jobId}`);

            // ExportJob fields:
            // - status: JobStatus (READY, PROCESSING, COMPLETED, CANCELLED, FAILED)
            // - resultUri: string (download URL when completed)
            // - errorMessage: string (error message when failed)
            // - rowsWritten: number
            // - batchesFlushed: number

            if (status.status === 'COMPLETED') {
                badge.className = 'status-badge status-done';
                badge.innerText = 'DONE';
                progress.style.width = '100%';

                if (status.resultUri) {
                    action.innerHTML = `<a href="${status.resultUri}" class="btn btn-outline" style="padding: 0.25rem 0.5rem; width: auto; font-size: 0.75rem;">Download</a>`;
                } else {
                    action.innerText = 'No file';
                }
            } else if (status.status === 'FAILED') {
                badge.className = 'status-badge status-failed';
                badge.innerText = 'FAILED';
                progress.style.width = '100%';
                progress.style.backgroundColor = '#ef4444';
                action.innerText = status.errorMessage || 'Error';
            } else if (status.status === 'PROCESSING') {
                badge.className = 'status-badge status-running';
                badge.innerText = 'RUNNING';
                // Use rowsWritten for progress indicator if available
                if (status.rowsWritten > 0) {
                    action.innerText = `${status.rowsWritten.toLocaleString()} rows`;
                }
                let w = parseFloat(progress.style.width) || 0;
                if (w < 90) progress.style.width = (w + 5) + '%';
            } else {
                // READY or other
                let w = parseFloat(progress.style.width) || 0;
                if (w < 90) progress.style.width = (w + 10) + '%';
            }
        }
    </script>

</body>

</html>